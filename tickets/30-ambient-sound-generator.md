# Ticket 30: Brown Noise / Ambient Sound Generator

**Priority:** Medium
**Component:** `frontend/app.js`, `frontend/style.css`
**Estimated Scope:** Medium
**Depends on:** Ticket 21 (Settings Panel — for sound type and volume settings)

## Overview

Add a built-in "Focus Sound" player that procedurally generates Brown Noise, Pink Noise, or simple Lo-Fi ambient tones using the Web Audio API. No audio files needed — all sounds are synthesized in the browser. The research identifies sound masking as a proven ADHD management technique, with Brown Noise being particularly effective.

## Research Context

Section 5.1 of the cognitive ergonomics report details how "colored" noises provide a "sound blanket" that dampens sensory spikes from the environment. Brown Noise (which decreases in intensity by 6dB per octave, creating a deep rumble like heavy rain) is often more effective than White Noise for ADHD brains because it raises the auditory threshold for sudden environmental sounds, helping calm "internal chatter" and regulate arousal levels. The report cites systematic review evidence supporting noise-assisted focus in ADHD learners.

## Sound Types

### Brown Noise (Brownian/Red Noise)
- Generated by integrating white noise (cumulative sum of random values)
- Deep, rumbly — like distant thunder or heavy rainfall
- Most commonly preferred by ADHD users for focus

### Pink Noise
- Power spectral density decreases at 3dB per octave
- Softer than white noise, more "natural" sounding — like steady rain
- Alternative for users who find brown noise too deep

### Off
- No ambient sound (default)

## UI Design

### Compact Player Control
- Small unobtrusive control in the header bar (or footer status bar)
- Icon: headphones or speaker icon
- Click to cycle: Off → Brown → Pink → Off
- Or: click to open a small dropdown with the options
- Volume slider appears on hover/click (thin horizontal slider)
- Currently active sound type shown as a small label or tooltip

### Settings Panel Integration
Under the "Audio" section:
- **Ambient Sound**: Dropdown (Off / Brown Noise / Pink Noise)
- **Volume**: Slider (0–100%)
- Changes apply immediately

## Implementation

### Web Audio API Approach

```javascript
class AmbientSoundGenerator {
    constructor() {
        this.audioCtx = null;  // lazy init on first play (autoplay policy)
        this.gainNode = null;
        this.sourceNode = null;
    }

    start(type, volume) {
        if (!this.audioCtx) {
            this.audioCtx = new AudioContext();
        }
        this.stop();

        const bufferSize = 4096;
        this.sourceNode = this.audioCtx.createScriptProcessor(bufferSize, 1, 1);
        this.gainNode = this.audioCtx.createGain();
        this.gainNode.gain.value = volume;

        if (type === 'brown-noise') {
            let lastOut = 0;
            this.sourceNode.onaudioprocess = (e) => {
                const output = e.outputBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    output[i] = (lastOut + (0.02 * white)) / 1.02;
                    lastOut = output[i];
                    output[i] *= 3.5; // volume compensation
                }
            };
        } else if (type === 'pink-noise') {
            let b0=0, b1=0, b2=0, b3=0, b4=0, b5=0, b6=0;
            this.sourceNode.onaudioprocess = (e) => {
                const output = e.outputBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    b0 = 0.99886*b0 + white*0.0555179;
                    b1 = 0.99332*b1 + white*0.0750759;
                    b2 = 0.96900*b2 + white*0.1538520;
                    b3 = 0.86650*b3 + white*0.3104856;
                    b4 = 0.55000*b4 + white*0.5329522;
                    b5 = -0.7616*b5 - white*0.0168980;
                    output[i] = b0+b1+b2+b3+b4+b5+b6+white*0.5362;
                    output[i] *= 0.11;
                    b6 = white * 0.115926;
                }
            };
        }

        this.sourceNode.connect(this.gainNode);
        this.gainNode.connect(this.audioCtx.destination);
    }

    setVolume(v) {
        if (this.gainNode) this.gainNode.gain.value = v;
    }

    stop() {
        if (this.sourceNode) {
            this.sourceNode.disconnect();
            this.sourceNode = null;
        }
    }
}
```

**Note:** `ScriptProcessorNode` is deprecated. For production, use `AudioWorkletNode` with a custom worklet. The above is a functional starting point — migrate to AudioWorklet if performance is an issue.

### Autoplay Policy
- Browsers block audio playback until a user gesture
- Initialize `AudioContext` on the first user click of the ambient sound control
- If the user has a saved preference (e.g., brown noise was on last session), show a "Resume focus sound?" prompt on first interaction with the page, or auto-start after the first click anywhere

### Volume Persistence
- Volume and sound type saved via SettingsManager
- Restored on page load (but playback requires user gesture to start)

## Implementation Steps

1. **Create `AmbientSoundGenerator` class** with brown/pink noise generation
2. **Add compact player control** in header — icon + dropdown + volume slider
3. **Wire to SettingsManager** — persist type and volume
4. **Handle autoplay policy** — lazy AudioContext init on first user gesture
5. **Add settings panel controls** — dropdown and slider in Audio section
6. **Test** across browsers (Chrome, Firefox, Safari)

## Acceptance Criteria

- [ ] Brown Noise plays continuously when selected — deep, rumbly sound
- [ ] Pink Noise plays continuously when selected — softer, natural sound
- [ ] Volume slider adjusts sound level in real time
- [ ] Sound type and volume persist across page refresh (playback resumes on first user gesture)
- [ ] Compact player control in header is unobtrusive (small icon)
- [ ] AudioContext is created only after user interaction (no autoplay policy violations)
- [ ] Stopping sound fully releases audio resources
- [ ] No audible clicks or pops when starting/stopping
- [ ] Works in Chrome, Firefox, and Safari
